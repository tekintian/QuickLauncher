name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: macos-latest
    
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            deployment_target: "10.15"
            config_name: "Intel"
          - arch: arm64
            deployment_target: "11.0"
            config_name: "ARM64"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Update Package Dependencies for CI
      run: |
        echo "üì¶ Updating Xcode project to use remote dependencies for CI..."
        
        # Backup original project file
        cp QuickLauncher.xcodeproj/project.pbxproj QuickLauncher.xcodeproj/project-local.pbxproj
        
        # Update Xcode project to use remote ShortcutRecorder
        sed 's|repositoryURL = "file://./LocalDependencies/ShortcutRecorder";|repositoryURL = "https://github.com/tekintian/ShortcutRecorder.git";|g' QuickLauncher.xcodeproj/project.pbxproj > temp.pbxproj && mv temp.pbxproj QuickLauncher.xcodeproj/project.pbxproj
        
        # Also update Package.swift for consistency
        cat > Package-ci.swift << 'EOF'
        // swift-tools-version:5.3
        // Package definition for QuickLauncher with remote dependencies (CI only)
        
        import PackageDescription
        
        let package = Package(
            name: "QuickLauncher",
            platforms: [
                .macOS(.v10_15)
            ],
            dependencies: [
                // Use remote ShortcutRecorder dependency for CI builds
                .package(url: "https://github.com/tekintian/ShortcutRecorder.git", from: "3.4.0")
            ],
            targets: [
                // ËøôÈáåÂÆö‰πâÈ°πÁõÆÁöÑ‰∏ªË¶ÅÁõÆÊ†á
                // Ê≥®ÊÑèÔºöËøô‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÂåÖËß£ÊûêÔºåÂÆûÈôÖÊûÑÂª∫‰ΩøÁî®XcodeÈ°πÁõÆ
            ]
        )
        EOF
        
        # Backup original Package.swift and use CI version
        cp Package.swift Package-local.swift
        cp Package-ci.swift Package.swift
        
        echo "‚úÖ Dependencies updated for CI build"
        
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift', '*.xcodeproj/**') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build (${{ matrix.config_name }})
      run: |
        echo "üèóÔ∏è Building ${{ matrix.config_name }} version..."
        export MACOSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }}
        
        # Build using Xcode project
        xcodebuild -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Debug \
          -arch ${{ matrix.arch }} \
          -derivedDataPath "DerivedData-${{ matrix.config_name }}" \
          MACOSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }} \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -allowProvisioningUpdates \
          clean build
          
        # Check binary
        echo "üîç Verifying ${{ matrix.config_name }} binary..."
        file "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app/Contents/MacOS/QuickLauncher"
        
        # Show app structure
        echo "üìã App structure:"
        find "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app" -name "*.plist" | head -3
        
        # Restore original files
        if [ -f "Package-local.swift" ]; then
          echo "üîÑ Restoring original Package.swift..."
          cp Package-local.swift Package.swift
        fi
        
        if [ -f "QuickLauncher.xcodeproj/project-local.pbxproj" ]; then
          echo "üîÑ Restoring original Xcode project..."
          cp QuickLauncher.xcodeproj/project-local.pbxproj QuickLauncher.xcodeproj/project.pbxproj
        fi
        
    - name: Lint
      run: |
        echo "üîç Running basic checks..."
        
        # Check for common Swift linting issues
        if command -v swiftlint &> /dev/null; then
          swiftlint --strict
        else
          echo "‚ö†Ô∏è SwiftLint not available, skipping linting"
        fi
        
        # Check file structure
        echo "üìÅ Checking project structure..."
        if [ ! -f "QuickLauncher/Info.plist" ]; then
          echo "‚ùå Missing QuickLauncher/Info.plist"
          exit 1
        fi
        
        if [ ! -d "QuickLauncher/Assets.xcassets" ]; then
          echo "‚ö†Ô∏è Missing assets directory"
        fi
        
        # Check script permissions
        echo "üîß Checking script permissions..."
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            if [ ! -x "$script" ]; then
              echo "‚ö†Ô∏è Script $script is not executable"
              chmod +x "$script"
            fi
          fi
        done
        
        echo "‚úÖ Basic checks completed"
        
    - name: Test Icon Update Script
      run: |
        echo "üé® Testing icon update script..."
        if [ -f "scripts/update_app_icons.sh" ] && [ -f "Resources/app-icon.png" ]; then
          # Test script syntax
          bash -n scripts/update_app_icons.sh
          echo "‚úÖ Icon update script syntax OK"
        else
          echo "‚ö†Ô∏è Icon update script or icon file not found"
        fi
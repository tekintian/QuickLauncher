# Description: Simplified GitHub Actions workflow for QuickLauncher
# Builds Intel and ARM64 versions using Xcode's built-in capabilities
# author: tekintian@gmail.com
# date: 2025-12-20
# version: 2.0.0

name: CI

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - config_name: Intel
            architecture: x86_64
            deployment_target: "10.13"
          - config_name: ARM64
            architecture: arm64
            deployment_target: "11.0"

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CI Environment
      run: |
        chmod +x scripts/ci-setup.sh
        ./scripts/ci-setup.sh

    - name: Install Dependencies
      run: |
        set -euo pipefail
        echo "üì¶ Installing dependencies..."
        # brew install xz if not already installed
        if ! command -v xz &> /dev/null; then
          echo "üç∫ Installing xz..."
          brew install xz
        else
          echo "‚úÖ xz is already installed"
        fi

    - name: Build App
      run: |
        # Use proper destination that includes architecture
        if [[ "${{ matrix.architecture }}" == "x86_64" ]]; then
          DESTINATION="platform=macOS,arch=x86_64"
        else
          DESTINATION="platform=macOS,arch=arm64"
        fi
        
        xcodebuild clean build \
          -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Release \
          -derivedDataPath DerivedData-${{ matrix.config_name }} \
          -destination "$DESTINATION" \
          MACOSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        # tar the build output for reference
        echo "üì¶ Saving build output..."
        tar -cJf build-output-${{ matrix.config_name }}.tar.xz DerivedData-${{ matrix.config_name }}/Build/Products/
        echo "üì¶ Build output saved to build-output-${{ matrix.config_name }}.tar.xz"

    - name: Create Artifacts
      run: |
        # Find and work directly with the built app (no copy to avoid du calculation issues)
        APP_PATH=$(find DerivedData-${{ matrix.config_name }} -name "QuickLauncher.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No app bundle found"
          exit 1
        fi
        
        echo "find app bundle at: $APP_PATH"

        # Step 3: Prepare CI-Artifacts directory
        rm -rf CI-Artifacts
        mkdir -p CI-Artifacts
        # Save build output tar for reference
        mv build-output-${{ matrix.config_name }}.tar.xz CI-Artifacts/build-output-${{ matrix.config_name }}.tar.xz

        echo "üßπ Running library cleanup script..."
   
        if [ -f "./scripts/clean-libs.sh" ]; then
          chmod +x ./scripts/clean-libs.sh
          ./scripts/clean-libs.sh "$APP_PATH"
          echo "‚úÖ Library cleanup completed"
        else
          echo "‚ö†Ô∏è clean-libs.sh script not found"
        fi
        
        # Basic verification
        [ -f "$APP_PATH/Contents/MacOS/QuickLauncher" ] || exit 1
        [ -x "$APP_PATH/Contents/MacOS/QuickLauncher" ] || exit 1
        
        # Step 4: Package the final app bundle
        echo " moving $APP_PATH to CI-Artifacts/QuickLauncher.app "
        mv $APP_PATH CI-Artifacts/QuickLauncher.app
        cd CI-Artifacts
        echo "  üìã Packaging final app bundle: CI-Artifacts/QuickLauncher.app"
        tar -cJf "QuickLauncher-${{ matrix.config_name }}-Final.tar.xz" QuickLauncher.app"
       
        echo "  üìä Final package size: $(du -sh "QuickLauncher-${{ matrix.config_name }}-Final.tar.xz" | cut -f1)" 
        # Show all packages
        echo "üìã All generated packages:"
        ls -lh *.tar.xz
        cd ..
        echo "‚úÖ ${{ matrix.config_name }} build completed"
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickLauncher-${{ matrix.config_name }}-${{ github.run_number }}
        path: CI-Artifacts/*.tar.xz
        retention-days: 7
        compression-level: 0
        if-no-files-found: error
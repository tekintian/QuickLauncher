# Description: Simplified GitHub Actions workflow for QuickLauncher
# Builds Intel and ARM64 versions using Xcode's built-in capabilities
# author: tekintian@gmail.com
# date: 2025-12-20
# version: 2.0.0

name: CI

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - config_name: Intel
            architecture: x86_64
            deployment_target: "10.13"
          - config_name: ARM64
            architecture: arm64
            deployment_target: "11.0"

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CI Environment
      run: |
        chmod +x scripts/ci-setup.sh
        ./scripts/ci-setup.sh

    - name: Install Dependencies
      run: |
        set -euo pipefail
        echo "ğŸ“¦ Installing dependencies..."
        brew install xz

    - name: Build App
      run: |
        # Use proper destination that includes architecture
        if [[ "${{ matrix.architecture }}" == "x86_64" ]]; then
          DESTINATION="platform=macOS,arch=x86_64"
        else
          DESTINATION="platform=macOS,arch=arm64"
        fi
        
        xcodebuild clean build \
          -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Release \
          -derivedDataPath DerivedData-${{ matrix.config_name }} \
          -destination "$DESTINATION" \
          MACOSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create Artifacts
      run: |
        # Find and copy the built app
        APP_PATH=$(find DerivedData-${{ matrix.config_name }} -name "QuickLauncher.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "âŒ No app bundle found"
          exit 1
        fi
        
        echo "ğŸ“ Found app at: $APP_PATH"
        APP_SIZE=$(du -sh "$APP_PATH" | cut -f1)
        echo "ğŸ“Š Builded app size: $APP_SIZE"
        
        rm -rf CI-Artifacts

        mkdir -p CI-Artifacts
        
        # Step 1: Copy and preserve original build
        cp -R "$APP_PATH" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}-Original.app"
        echo "ğŸ“¦ Original app copied"
        
        # Step 2: Create working copy for modifications
        cp -R "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}-Original.app" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
        
        echo "ğŸ”§ Checking Framework structure in CI-Artifacts..."
        FRAMEWORKS_DIR="CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/QuickLauncherCore.framework"
        
        if [ ! -d "$FRAMEWORKS_DIR" ]; then
            echo "âš ï¸ No Frameworks directory found"
            echo "ğŸ“ Available Frameworks:"
            ls -la "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/" || echo "No Frameworks directory"
            exit 0
        fi

        echo "ğŸ“ Framework directory exists: $FRAMEWORKS_DIR"
        echo "ğŸ“‹ Framework structure check:"
        ls -la "$FRAMEWORKS_DIR"
        
        # Check if Versions/Current is a symlink or directory
        if [ -L "$FRAMEWORKS_DIR/Versions/Current" ]; then
            CURRENT_TARGET=$(readlink "$FRAMEWORKS_DIR/Versions/Current")
            echo "  âœ… Versions/Current is symlink: $CURRENT_TARGET"
            
            # Verify symlink targets are valid
            if [ "$CURRENT_TARGET" = "A" ] && [ -d "$FRAMEWORKS_DIR/Versions/A" ]; then
                echo "  âœ… Symlink structure is correct"
            else
                echo "  âŒ Symlink structure broken - fixing..."
                cd "$FRAMEWORKS_DIR"
                rm -f Versions/Current
                ln -sf A Versions/Current
                cd /Users/runner/work/QuickLauncher/QuickLauncher
            fi
        elif [ -d "$FRAMEWORKS_DIR/Versions/Current" ]; then
            echo "  âš ï¸ Versions/Current is a directory, creating proper symlink structure"
            cd "$FRAMEWORKS_DIR"
            echo "    ğŸ”„ Moving Current directory contents to A..."
            if [ ! -d "Versions/A" ]; then
                mv "Versions/Current" "Versions/A"
            else
                # Merge contents if A already exists
                cp -R "Versions/Current/"* "Versions/A/" 2>/dev/null || true
                rm -rf "Versions/Current"
            fi
            echo "    ğŸ”— Creating Current -> A symlink..."
            cd Versions
            ln -sf A Current
            cd ..
            echo "    ğŸ”— Updating top-level symlinks..."
            rm -f QuickLauncherCore Resources 2>/dev/null || true
            ln -sf Versions/A/QuickLauncherCore QuickLauncherCore
            ln -sf Versions/A/Resources Resources
            cd /Users/runner/work/QuickLauncher/QuickLauncher
            echo "  âœ… Symlink structure fixed"
        else
            echo "  âŒ Versions/Current missing"
        fi
        
        echo "ğŸ“‹ Final Framework structure:"
        ls -la "$FRAMEWORKS_DIR"
        
        # Detailed symlink verification
        echo "ğŸ” Detailed symlink verification:"
        if [ -L "$FRAMEWORKS_DIR/QuickLauncherCore" ]; then
            BINARY_TARGET=$(readlink "$FRAMEWORKS_DIR/QuickLauncherCore")
            if [ -f "$FRAMEWORKS_DIR/$BINARY_TARGET" ]; then
                echo "  âœ… QuickLauncherCore symlink valid: $BINARY_TARGET"
            else
                echo "  âŒ QuickLauncherCore symlink broken: $BINARY_TARGET (target missing)"
            fi
        else
            echo "  âŒ QuickLauncherCore is not a symlink!"
            if [ -f "$FRAMEWORKS_DIR/QuickLauncherCore" ]; then
                echo "  ğŸš¨ QuickLauncherCore is a real file - symlink was broken!"
                echo "  ğŸ”„ Fixing: removing duplicate file and recreating symlink"
                cd "$FRAMEWORKS_DIR"
                rm -f QuickLauncherCore
                ln -sf Versions/A/QuickLauncherCore QuickLauncherCore
                cd /Users/runner/work/QuickLauncher/QuickLauncher
            fi
        fi
        
        if [ -L "$FRAMEWORKS_DIR/Resources" ]; then
            RESOURCES_TARGET=$(readlink "$FRAMEWORKS_DIR/Resources")
            if [ -d "$FRAMEWORKS_DIR/$RESOURCES_TARGET" ]; then
                echo "  âœ… Resources symlink valid: $RESOURCES_TARGET"
            else
                echo "  âŒ Resources symlink broken: $RESOURCES_TARGET (target missing)"
            fi
        else
            echo "  âŒ Resources is not a symlink!"
            if [ -d "$FRAMEWORKS_DIR/Resources" ]; then
                echo "  ğŸš¨ Resources is a real directory - symlink was broken!"
                echo "  ğŸ”„ Fixing: removing duplicate directory and recreating symlink"
                cd "$FRAMEWORKS_DIR"
                rm -rf Resources
                ln -sf Versions/A/Resources Resources
                cd /Users/runner/work/QuickLauncher/QuickLauncher
            fi
        fi
        
        # Check for duplicate files in Framework
        echo "ğŸ” Checking for duplicate files in Framework:"
        cd "$FRAMEWORKS_DIR"
        find . -type f -exec basename {} \; | sort | uniq -d | while read file; do
            echo "  âš ï¸ Duplicate file found: $file"
            find . -name "$file" -ls
        done
        cd /Users/runner/work/QuickLauncher/QuickLauncher
        
        # Step 3: Package after framework fixes (before library cleanup)
        echo "ğŸ“¦ Creating post-framework-fix package..."
        cd CI-Artifacts
        tar -cJf "QuickLauncher-${{ matrix.config_name }}-PostFrameworkFix.tar.xz" "QuickLauncher-${{ matrix.config_name }}.app"
        echo "  ğŸ“Š Post-framework-fix package size: $(du -sh "QuickLauncher-${{ matrix.config_name }}-PostFrameworkFix.tar.xz" | cut -f1)"
        cd ..
        
        echo "ğŸ§¹ Running library cleanup script..."
        
        # Pre-cleanup size analysis
        echo "ğŸ“Š Pre-cleanup analysis:"
        APP_SIZE_BEFORE=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" | cut -f1)
        echo "  App size before cleanup: $APP_SIZE_BEFORE"
        LIBS_SIZE_BEFORE=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/"*.dylib 2>/dev/null | awk '{sum+=$1} END {print sum "B"}' || echo "0B")
        echo "  Libraries size before cleanup: $LIBS_SIZE_BEFORE"
        LIBS_COUNT_BEFORE=$(ls -1 "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/"*.dylib 2>/dev/null | wc -l)
        echo "  Libraries count before cleanup: $LIBS_COUNT_BEFORE"
        
        if [ -f "./scripts/clean-libs.sh" ]; then
          chmod +x ./scripts/clean-libs.sh
          ./scripts/clean-libs.sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
          echo "âœ… Library cleanup completed"
        else
          echo "âš ï¸ clean-libs.sh script not found"
        fi

        # Post-cleanup size analysis
        echo "ğŸ“Š Post-cleanup analysis:"
        APP_SIZE_AFTER=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" | cut -f1)
        echo "  App size after cleanup: $APP_SIZE_AFTER"
        LIBS_SIZE_AFTER=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/"*.dylib 2>/dev/null | awk '{sum+=$1} END {print sum "B"}' || echo "0B")
        echo "  Libraries size after cleanup: $LIBS_SIZE_AFTER"
        LIBS_COUNT_AFTER=$(ls -1 "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/"*.dylib 2>/dev/null | wc -l)
        echo "  Libraries count after cleanup: $LIBS_COUNT_AFTER"
        
        # Calculate size difference
        echo "ğŸ“Š Size difference analysis:"
        if [ "$APP_SIZE_BEFORE" != "$APP_SIZE_AFTER" ]; then
            echo "  âš ï¸ App size changed: $APP_SIZE_BEFORE -> $APP_SIZE_AFTER"
            echo "  ğŸ” This indicates a potential symlink or filesystem issue"
        else
            echo "  âœ… App size unchanged (expected)"
        fi
        
        # Basic verification
        [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ] || exit 1
        [ -x "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ] || exit 1
        
        # Step 4: Create final packages
        echo "ğŸ“¦ Creating final packages..."
        cd CI-Artifacts
        
        # Package original build
        tar -cJf "QuickLauncher-${{ matrix.config_name }}-Original.tar.xz" "QuickLauncher-${{ matrix.config_name }}-Original.app"
        echo "  ğŸ“Š Original package size: $(du -sh "QuickLauncher-${{ matrix.config_name }}-Original.tar.xz" | cut -f1)"
        
        # Package final build
        tar -cJf "QuickLauncher-${{ matrix.config_name }}-Final.tar.xz" "QuickLauncher-${{ matrix.config_name }}.app"
        echo "  ğŸ“Š Final package size: $(du -sh "QuickLauncher-${{ matrix.config_name }}-Final.tar.xz" | cut -f1)"
        
        # Show all packages
        echo "ğŸ“‹ All generated packages:"
        ls -lh *.tar.xz
        
        cd ..
        
        echo "âœ… ${{ matrix.config_name }} build completed"

    - name: Verify Artifacts
      run: |
        echo "ğŸ” Verifying created packages..."
        cd CI-Artifacts
        
        chmod +x ../scripts/verify-artifact.sh
        
        for package in *.tar.xz; do
          echo "ğŸ“¦ Verifying $package..."
          package_name=$(basename "$package" .tar.xz)
          ../scripts/verify-artifact.sh "$package_name"
          echo "---"
        done

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickLauncher-${{ matrix.config_name }}-${{ github.run_number }}
        path: CI-Artifacts/*.tar.xz
        retention-days: 7
        compression-level: 0
        if-no-files-found: error
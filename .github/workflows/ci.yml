# Description: Simplified GitHub Actions workflow for QuickLauncher
# Builds Intel and ARM64 versions using Xcode's built-in capabilities
# author: tekintian@gmail.com
# date: 2025-12-20
# version: 2.0.0

name: CI

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - config_name: Intel
            architecture: x86_64
            deployment_target: "10.13"
          - config_name: ARM64
            architecture: arm64
            deployment_target: "11.0"

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CI Environment
      run: |
        chmod +x scripts/ci-setup.sh
        ./scripts/ci-setup.sh

    - name: Build App
      run: |
        # Use proper destination that includes architecture
        if [[ "${{ matrix.architecture }}" == "x86_64" ]]; then
          DESTINATION="platform=macOS,arch=x86_64"
        else
          DESTINATION="platform=macOS,arch=arm64"
        fi
        
        xcodebuild clean build \
          -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Release \
          -derivedDataPath DerivedData-${{ matrix.config_name }} \
          -destination "$DESTINATION" \
          MACOSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create Artifacts
      run: |
        # Find and copy the built app
        APP_PATH=$(find DerivedData-${{ matrix.config_name }} -name "QuickLauncher.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "‚ùå No app bundle found"
          exit 1
        fi
        
        echo "üìÅ Found app at: $APP_PATH"
        mkdir -p CI-Artifacts
        cp -R "$APP_PATH" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
        
        echo "üîç Checking Framework structure BEFORE fix:"
        if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks" ]; then
          find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks" -name "*.framework" -type d | while read fw; do
            fw_name=$(basename "$fw" .framework)
            echo "  üì¶ Framework: $fw_name"
            if [ -f "$fw/$fw_name" ] && [ ! -L "$fw/$fw_name" ]; then
              echo "    ‚ùå $fw_name is a FILE (should be symlink)"
            elif [ -L "$fw/$fw_name" ]; then
              echo "    ‚úÖ $fw_name is already a symlink"
            else
              echo "    ‚ö†Ô∏è $fw_name not found"
            fi
          done
        fi
        
        echo "üîß Running Framework fix script..."
        if [ -f "./scripts/fix-frameworks.sh" ]; then
          chmod +x ./scripts/fix-frameworks.sh
          ./scripts/fix-frameworks.sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
          echo "‚úÖ Framework fix script completed"
        else
          echo "‚ùå fix-frameworks.sh script not found"
          exit 1
        fi
        
        echo "üßπ Running library cleanup script..."
        if [ -f "./scripts/clean-libs.sh" ]; then
          chmod +x ./scripts/clean-libs.sh
          ./scripts/clean-libs.sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
          echo "‚úÖ Library cleanup completed"
        else
          echo "‚ö†Ô∏è clean-libs.sh script not found"
        fi
        
        # Verify Framework structure
        if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks" ]; then
            echo "üîç Verifying Framework structure..."
            find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks" -name "*.framework" -type d | while read fw; do
                fw_name=$(basename "$fw" .framework)
                echo "  üì¶ Framework: $fw_name"
                
                # Check key symlinks
                if [ -L "$fw/Versions/Current" ]; then
                    echo "    ‚úÖ Versions/Current -> $(readlink $fw/Versions/Current)"
                else
                    echo "    ‚ùå Versions/Current symlink missing"
                fi
                
                if [ -L "$fw/$fw_name" ]; then
                    echo "    ‚úÖ $fw_name -> $(readlink $fw/$fw_name)"
                else
                    echo "    ‚ùå $fw_name symlink missing"
                fi
                
                if [ -L "$fw/Resources" ]; then
                    echo "    ‚úÖ Resources -> $(readlink $fw/Resources)"
                else
                    echo "    ‚ùå Resources symlink missing"
                fi
            done
        fi
        
        # Basic verification
        [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ] || exit 1
        [ -x "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ] || exit 1
        
        # Optional detailed framework debug (only on failure or when needed)
        if [ "${{ matrix.config_name }}" = "Intel" ]; then
            echo "üîç Running detailed framework debug..."
            find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks" -name "*.framework" -type d | head -1 | while read fw; do
                ./scripts/debug-framework.sh "$fw"
            done
        fi
        
        # Show final app size
        APP_SIZE=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" | cut -f1)
        echo "üìä Final app size: $APP_SIZE"
        
        echo "‚úÖ ${{ matrix.config_name }} build completed"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickLauncher-${{ matrix.config_name }}-${{ github.run_number }}
        path: CI-Artifacts/
        retention-days: 7
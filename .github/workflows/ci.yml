# Description: GitHub Actions workflow to build QuickLauncher for macOS
# Triggers on push to main, master, or develop branches, and pull requests to these branches.
# Builds Intel and ARM64 versions, with optional code signing (self-signed or developer certificate).
# Generates release notes highlighting features, improvements, and installation instructions.
# author: tekintian@gmail.com   https://dev.tekin.cn
# date: 2025-12-20
# version: 1.0.0
# license: MIT
name: CI

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - config_name: Intel
            architecture: x86_64
            deployment_target: 10.13
          - config_name: ARM64
            architecture: arm64
            deployment_target: 11.0

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Update local dependencies for CI build
      run: |
        echo "üîÑ Preparing CI build configuration..."
        
        # Â§á‰ªΩÂéüÂßãÈ°πÁõÆÊñá‰ª∂
        if [ -f "Package.swift" ]; then
          cp Package.swift Package-local.swift
        fi
        
        if [ -f "QuickLauncher.xcodeproj/project.pbxproj" ]; then
          cp QuickLauncher.xcodeproj/project.pbxproj QuickLauncher.xcodeproj/project-local.pbxproj
        fi
        
        # Â∞ÜÊú¨Âú∞ShortcutRecorder‰æùËµñÊõøÊç¢‰∏∫ËøúÁ®ãURL
        echo "üîÑ Configuring remote dependencies..."
        sed -i '' -E 's|repositoryURL = "file://./LocalDependencies/ShortcutRecorder"|repositoryURL = "https://github.com/tekintian/ShortcutRecorder.git"|g' QuickLauncher.xcodeproj/project.pbxproj
        
        # Â§á‰ªΩÂπ∂ÊõøÊç¢Package.swift‰∏∫È°πÁõÆ‰∏≠Â∑≤ÊúâÁöÑCIÁâàÊú¨
        if [ -f "Package.swift" ]; then
          cp Package.swift Package.swift.backup
        fi
        cp Package-ci.swift Package.swift

    - name: Cache Swift Packages
      uses: actions/cache@v4
      with:
        path: |
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}-${{ hashFiles('**/*.xcodeproj') }}
        restore-keys: |
          ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}-

    - name: Build
      run: |
        # Set up error handling to restore files on failure
        trap 'echo "‚ùå Build failed, restoring original files..."; \
              if [ -f "Package-local.swift" ]; then cp Package-local.swift Package.swift; fi; \
              if [ -f "QuickLauncher.xcodeproj/project-local.pbxproj" ]; then cp QuickLauncher.xcodeproj/project-local.pbxproj QuickLauncher.xcodeproj/project.pbxproj; fi; \
              exit 1' ERR
        
        echo "üöÄ Building ${{ matrix.config_name }} configuration..."
        
        # ÂÆö‰πâÊûÑÂª∫ÂèÇÊï∞
        XCODE_PROJECT="QuickLauncher.xcodeproj"
        SCHEME="QuickLauncher"
        DERIVED_DATA_PATH="DerivedData-${{ matrix.config_name }}"
        
        # ÊâßË°åÊûÑÂª∫ÂëΩ‰ª§Ôºå‰øÆÂ§ç‰∫Ü-deploymentTargetÂèÇÊï∞‰∏∫Ê≠£Á°ÆÁöÑMACOSX_DEPLOYMENT_TARGET
        # ‰ΩøÁî®ONLY_ACTIVE_ARCH=YESÊù•ÈÅøÂÖçSwiftÊ®°ÂùóÂÜ≤Á™Å
        xcodebuild clean build \
          -project "$XCODE_PROJECT" \
          -scheme "$SCHEME" \
          -destination "platform=macOS,arch=${{ matrix.architecture }}" \
          -derivedDataPath "$DERIVED_DATA_PATH" \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED="NO" \
          CODE_SIGNING_ALLOWED="NO" \
          PRODUCT_BUNDLE_IDENTIFIER="cn.tekin.app.QuickLauncher" \
          PRODUCT_NAME="QuickLauncher" \
          BUNDLE_SHORT_VERSION_STRING="1.0.0" \
          BUNDLE_VERSION="1" \
          MACOSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}" \
          ENABLE_BITCODE=NO \
          ONLY_ACTIVE_ARCH=YES \
          COMPRESS_PNG_RESOURCES=YES \
          DEAD_CODE_STRIPPING="YES" \
          STRIP_INSTALLED_PRODUCT="YES" \
          COPY_PHASE_STRIP="YES" \
          STRIP_STYLE="non-global"
        
        # È™åËØÅÊûÑÂª∫ÁªìÊûú
        if [ $? -eq 0 ]; then
          echo "‚úÖ Build completed successfully"
        else
          echo "‚ùå Build failed"
          exit 1
        fi
        
        # Check DerivedData directory structure
        echo "üìÅ Checking DerivedData structure..."
        ls -la "$DERIVED_DATA_PATH/Build/Products/"
        
        # Find the built app bundle - simplified search
        echo "üîç Searching for app bundle..."
        APP_PATH=""
        ARCH="${{ matrix.architecture }}"
        
        # Since we specified -configuration Release, expect Release configuration
        if [ -d "$DERIVED_DATA_PATH/Build/Products/Release/QuickLauncher.app" ]; then
          APP_PATH="$DERIVED_DATA_PATH/Build/Products/Release/QuickLauncher.app"
          BUILD_CONFIG="Release"
        elif [ -d "$DERIVED_DATA_PATH/Build/Products/Release-$ARCH/QuickLauncher.app" ]; then
          APP_PATH="$DERIVED_DATA_PATH/Build/Products/Release-$ARCH/QuickLauncher.app"
          BUILD_CONFIG="Release-$ARCH"
        else
          # Fallback: global search for app bundle
          echo "üìÅ Using global search for app bundle:"
          APP_PATH=$(find "$DERIVED_DATA_PATH/Build/Products" -name "QuickLauncher.app" -type d | head -1)
          
          if [ -n "$APP_PATH" ]; then
            BUILD_CONFIG=$(basename "$(dirname "$APP_PATH")")
          else
            echo "‚ùå ${{ matrix.config_name }} build failed - no app bundle found"
            echo "üìÅ Detailed search for all app bundles:"
            find "$DERIVED_DATA_PATH" -name "*.app" -type d || echo "No app bundles found"
            echo "üìÅ Products directory contents:"
            find "$DERIVED_DATA_PATH/Build/Products" -type f -o -type d
            exit 1
          fi
        fi
        
        echo "‚úÖ Found app bundle in $BUILD_CONFIG configuration at $APP_PATH"
        ls -la "$APP_PATH/Contents/"
        
        # Check binary
        echo "üîç Verifying ${{ matrix.config_name }} binary..."
        file "$APP_PATH/Contents/MacOS/QuickLauncher"
        
        # Show app structure
        echo "üìã App structure:"
        find "$APP_PATH" -name "*.plist" | head -3
        
        # Create CI build artifacts
        echo "üì¶ Creating CI artifacts for ${{ matrix.config_name }}..."
        mkdir -p CI-Artifacts
        
        # Copy the built app
        cp -R "$APP_PATH" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
        
        # Ensure proper permissions
        chmod -R 755 "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
        
        # Clean debug symbols to match local build behavior
        echo "üóëÔ∏è Cleaning debug symbols..."
        find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" -name "*.dSYM" -exec rm -rf {} \; 2>/dev/null || true
        
        # Copy localization files (important for Preferences window)
        echo "üåç Copying localization files..."
        if [ -f "scripts/copy_localization.sh" ]; then
          PROJECT_DIR="$(pwd)"
          BUILD_DIR="$PROJECT_DIR/build"
          
          # Update the copy_localization script to work with CI artifacts
          LANGUAGES=("zh-Hans" "en" "fr" "ru" "it" "es" "de" "ko" "tr")
          
          for lang in "${LANGUAGES[@]}"; do
            SOURCE_FILE="$PROJECT_DIR/QuickLauncher/PreferencesWindow/${lang}.lproj/Preferences.strings"
            TARGET_DIR="CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources/${lang}.lproj"
            
            if [ -f "$SOURCE_FILE" ]; then
              echo "  Copying $lang Preferences.strings"
              mkdir -p "$TARGET_DIR"
              cp "$SOURCE_FILE" "$TARGET_DIR/"
            fi
          done
        else
          echo "‚ö†Ô∏è Localization script not found"
        fi
        
        # Remove unused Swift libraries to match local build behavior
        echo "üóëÔ∏è  Removing unused Swift libraries..."
        UNUSED_LIBS=(
            "libswiftCloudKit.dylib"
            "libswiftCoreLocation.dylib" 
            "libswiftCoreData.dylib"
            "libswiftMetal.dylib"
            "libswiftCoreImage.dylib"
            "libswiftIOKit.dylib"
            "libswiftQuartzCore.dylib"
        )
        
        for lib in "${UNUSED_LIBS[@]}"; do
          LIB_PATH="CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks/$lib"
          if [ -f "$LIB_PATH" ]; then
            rm "$LIB_PATH"
            echo "    Removed unused library: $lib"
          fi
        done
        
        # Fix unparsed build variables in all Info.plist files
        echo "üîß Fixing unparsed build variables in Info.plist files..."
        
        # Define the expected values for build variables
        PRODUCT_BUNDLE_IDENTIFIER="cn.tekin.app.QuickLauncher"
        PRODUCT_NAME="QuickLauncher"
        BUNDLE_SHORT_VERSION_STRING="1.0.0"
        BUNDLE_VERSION="1"
        
        # Find all Info.plist files in the app bundle and fix variables
        find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" -name "Info.plist" -type f | while read plist_path; do
          echo "  Fixing variables in: $(basename "$(dirname "$(dirname "$plist_path")")")/Info.plist"
          
          # Fix bundle identifier
          if /usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "$plist_path" 2>/dev/null | grep -q "\$(PRODUCT_BUNDLE_IDENTIFIER)"; then
            /usr/libexec/PlistBuddy -c "Set CFBundleIdentifier $PRODUCT_BUNDLE_IDENTIFIER" "$plist_path"
          fi
          
          # Fix executable name
          if /usr/libexec/PlistBuddy -c "Print CFBundleExecutable" "$plist_path" 2>/dev/null | grep -q "\$(PRODUCT_NAME)"; then
            # Use the bundle name as the executable name for non-main app bundles
            bundle_name=$(basename "$(dirname "$(dirname "$plist_path")")" .bundle)
            bundle_name=$(basename "$bundle_name" .framework)
            bundle_name=$(basename "$bundle_name" .appex)
            /usr/libexec/PlistBuddy -c "Set CFBundleExecutable $bundle_name" "$plist_path"
          fi
          
          # Fix version strings
          if /usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$plist_path" 2>/dev/null | grep -q "\$(BUNDLE_SHORT_VERSION_STRING)"; then
            /usr/libexec/PlistBuddy -c "Set CFBundleShortVersionString $BUNDLE_SHORT_VERSION_STRING" "$plist_path"
          fi
          
          if /usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$plist_path" 2>/dev/null | grep -q "\$(BUNDLE_VERSION)"; then
            /usr/libexec/PlistBuddy -c "Set CFBundleVersion $BUNDLE_VERSION" "$plist_path"
          fi
          
          # Fix product name if referenced
          if /usr/libexec/PlistBuddy -c "Print CFBundleName" "$plist_path" 2>/dev/null | grep -q "\$(PRODUCT_NAME)"; then
            /usr/libexec/PlistBuddy -c "Set CFBundleName $PRODUCT_NAME" "$plist_path"
          fi
        done
        
        # NOTE: Resources are already compiled and included by Xcode build
        # No need to copy source resources - they would corrupt the built app structure
        
        # Apply ad-hoc signature for macOS compatibility - sign all components with sandbox support
        echo "üîê Applying ad-hoc signature to all components..."
        
        # Ensure plugins have proper sandbox entitlements
        find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/PlugIns" -name "*.appex" -type d | while read plugin; do
          echo "  Configuring sandbox for plugin: $(basename "$plugin")"
          
          # Add required sandbox entitlements for Finder extension
          PLIST_PATH="$plugin/Contents/Info.plist"
          if [ -f "$PLIST_PATH" ]; then
            # Add sandbox entitlements for Finder sync extension
            /usr/libexec/PlistBuddy -c "Add :com.apple.security.app-sandbox bool true" "$PLIST_PATH" 2>/dev/null || echo "    Sandbox key already exists"
            /usr/libexec/PlistBuddy -c "Add :com.apple.security.files.user-selected.read-write bool true" "$PLIST_PATH" 2>/dev/null || echo "    File access key already exists"
            /usr/libexec/PlistBuddy -c "Add :com.apple.security.temporary-exception.mach-lookup.global-name array" "$PLIST_PATH" 2>/dev/null || echo "    Mach lookup array already exists"
            /usr/libexec/PlistBuddy -c "Add :com.apple.security.temporary-exception.mach-lookup.global-name:0 string com.apple.FinderSync" "$PLIST_PATH" 2>/dev/null || echo "    Finder sync entry already exists"
          fi
          
          echo "  Signing plugin: $(basename "$plugin")"
          codesign --force --sign "-" --options runtime --entitlements <(echo '<?xml version="1.0" encoding="UTF-8"?>'
          '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">'
          '<plist version="1.0">'
          '<dict>'
              '<key>com.apple.security.app-sandbox</key>'
              '<true/>'
              '<key>com.apple.security.files.user-selected.read-write</key>'
              '<true/>'
              '<key>com.apple.security.temporary-exception.mach-lookup.global-name</key>'
              '<array>'
                  '<string>com.apple.FinderSync</string>'
              '</array>'
          '</dict>'
          '</plist>') "$plugin" || echo "  ‚ö†Ô∏è Plugin signing failed"
        done
        
        # Sign frameworks
        find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Frameworks" -name "*.framework" -type d | while read framework; do
          echo "  Signing framework: $(basename "$framework")"
          
          # Fix framework library ID for proper dylib loading
          FRAMEWORK_NAME=$(basename "$framework" .framework)
          FRAMEWORK_BINARY="$framework/$FRAMEWORK_NAME"
          if [ -f "$FRAMEWORK_BINARY" ]; then
            echo "    Fixing framework library ID for $FRAMEWORK_NAME"
            install_name_tool -id "@rpath/$FRAMEWORK_NAME.framework/Versions/A/$FRAMEWORK_NAME" "$FRAMEWORK_BINARY" 2>/dev/null || echo "    Library ID already correct"
          fi
          
          codesign --force --sign "-" --options runtime "$framework" || echo "  ‚ö†Ô∏è Framework signing failed"
        done
        
        # Fix main app dependency paths
        echo "  Fixing main app dependency paths..."
        MAIN_BINARY="CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher"
        if [ -f "$MAIN_BINARY" ]; then
          # Fix dylib references to use proper framework paths
          install_name_tool -change "@rpath/QuickLauncher.debug.dylib" "@rpath/QuickLauncherCore.framework/Versions/A/QuickLauncherCore" "$MAIN_BINARY" 2>/dev/null || echo "    Dependencies already correct"
        fi
        
        # Sign main app
        echo "  Signing main app bundle..."
        codesign --force --deep --sign "-" --options runtime "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" || echo "‚ö†Ô∏è Main app signing failed"
        
        # Verify app structure in artifact
        echo "üîç Verifying CI artifact structure..."
        ls -la "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/"
        
        # Test basic app functionality (comprehensive validation)
        echo "üß™ Running comprehensive app validation..."
        
        # Check Info.plist
        if [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Info.plist" ]; then
          echo "‚úÖ Info.plist exists"
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Info.plist" 2>/dev/null || echo "cn.tekin.app.QuickLauncher")
          echo "üìã Bundle ID: $BUNDLE_ID"
        else
          echo "‚ùå Info.plist missing"
          exit 1
        fi
        
        # Check executable
        if [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ]; then
          echo "‚úÖ Executable exists"
          BINARY_INFO=$(file "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher")
          echo "üìã Binary: $BINARY_INFO"
        else
          echo "‚ùå Executable missing"
          exit 1
        fi
        
        # Check Resources
        if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources" ]; then
          echo "‚úÖ Resources directory exists"
          ASSETS_COUNT=$(find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources" -name "*.xcassets" | wc -l)
          LOCALIZATION_COUNT=$(find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources" -name "*.lproj" | wc -l)
          echo "üìã Assets: $ASSETS_COUNT, Localization: $LOCALIZATION_COUNT"
        else
          echo "‚ö†Ô∏è Resources directory missing (may be optional)"
        fi
        
        # Check code signature
        echo "üîç Checking code signature..."
        if codesign --verify --verbose "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" 2>/dev/null; then
          echo "‚úÖ Code signature valid"
        else
          echo "‚ö†Ô∏è Code signature verification failed (may be expected for ad-hoc signing)"
        fi
        
        # Test basic macOS compatibility
        echo "üß™ Testing macOS compatibility..."
        if [ -x "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ]; then
          echo "‚úÖ Executable has proper permissions"
          # Quick architecture check
          ARCH_CHECK=$(lipo -info "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" 2>/dev/null || echo "Single arch")
          echo "üìã Architecture: $ARCH_CHECK"
        else
          echo "‚ùå Executable not executable"
          exit 1
        fi
        
        echo "‚úÖ ${{ matrix.config_name }} build and artifact creation completed"
        
        # Show final artifact structure
        echo "üì¶ Final CI artifact structure:"
        ls -la CI-Artifacts/
        if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" ]; then
          echo "App bundle structure:"
          find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" -name "Contents" -type d | while read contents_dir; do
            echo "üìÅ $contents_dir"
            ls -la "$contents_dir/"
          done
        fi
        
        # Final integrity test
        echo "üîç Running final integrity test..."
        APP_SIZE=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" | cut -f1)
        echo "üìä App bundle size: $APP_SIZE"
        
        # Verify required directory structure
        REQUIRED_DIRS=("Contents/MacOS" "Contents/Resources" "Contents")
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/$dir" ]; then
            echo "‚úÖ Directory $dir exists"
          else
            echo "‚ö†Ô∏è Directory $dir missing"
          fi
        done
        
        # Verify required files
        REQUIRED_FILES=("Contents/Info.plist" "Contents/MacOS/QuickLauncher")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/$file" ]; then
            echo "‚úÖ File $file exists"
          else
            echo "‚ùå Required file $file missing"
            exit 1
          fi
        done
        
        # Restore original files (always run)
        echo "üîÑ Restoring original project files..."
        if [ -f "Package-local.swift" ]; then
          echo "üîÑ Restoring original Package.swift..."
          cp Package-local.swift Package.swift
        fi
        
        if [ -f "QuickLauncher.xcodeproj/project-local.pbxproj" ]; then
          echo "üîÑ Restoring original Xcode project..."
          cp QuickLauncher.xcodeproj/project-local.pbxproj QuickLauncher.xcodeproj/project.pbxproj
        fi
        
        # Cleanup backup files
        rm -f Package-local.swift QuickLauncher.xcodeproj/project-local.pbxproj

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickLauncher-${{ matrix.config_name }}-CI-${{ github.run_number }}
        path: CI-Artifacts/
        retention-days: 7
        if-no-files-found: error
        
    - name: Lint
      run: |
        echo "üîç Running basic checks..."
        
        # Check for common Swift linting issues
        if command -v swiftlint &> /dev/null; then
          swiftlint --strict
        else
          echo "‚ö†Ô∏è SwiftLint not available, skipping linting"
        fi
        
        # Check file structure
        echo "üìÅ Checking project structure..."
        if [ ! -f "QuickLauncher/Info.plist" ]; then
          echo "‚ùå Missing QuickLauncher/Info.plist"
          exit 1
        fi
        
        if [ ! -d "QuickLauncher/Assets.xcassets" ]; then
          echo "‚ö†Ô∏è Missing assets directory"
        fi
        
        # Check script permissions
        echo "üîß Checking script permissions..."
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            if [ ! -x "$script" ]; then
              echo "‚ö†Ô∏è Script $script is not executable"
              chmod +x "$script"
            fi
          fi
        done
        
        echo "‚úÖ Basic checks completed"

  verify-builds:
    needs: build
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Intel Build
      uses: actions/download-artifact@v4
      with:
        name: QuickLauncher-Intel-CI-${{ github.run_number }}
        path: artifacts/intel/
        
    - name: Download ARM64 Build
      uses: actions/download-artifact@v4
      with:
        name: QuickLauncher-ARM64-CI-${{ github.run_number }}
        path: artifacts/arm64/
        
    - name: Verify Both Builds
      run: |
        echo "üîç Verifying downloaded CI builds..."
        
        # Check Intel build
        echo "üìã Intel build verification:"
        echo "Directory listing:"
        ls -la artifacts/intel/
        echo ""
        echo "Looking for QuickLauncher-Intel.app..."
        find artifacts/intel/ -name "*.app" -type d || echo "No .app directories found"
        echo ""
        
        if [ -d "artifacts/intel/QuickLauncher-Intel.app" ]; then
          echo "‚úÖ Intel app bundle exists"
          echo "Contents directory:"
          ls -la "artifacts/intel/QuickLauncher-Intel.app/Contents/"
          echo ""
          echo "Binary verification:"
          file "artifacts/intel/QuickLauncher-Intel.app/Contents/MacOS/QuickLauncher"
          echo ""
          echo "Bundle identifier:"
          /usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "artifacts/intel/QuickLauncher-Intel.app/Contents/Info.plist" || echo "‚ö†Ô∏è Could not read bundle identifier"
        else
          echo "‚ùå Intel app bundle missing"
          echo "Available items:"
          find artifacts/intel/ -type f -o -type d | head -10
          exit 1
        fi
        
        echo ""
        echo "=========================================="
        echo ""
        
        # Check ARM64 build
        echo "üìã ARM64 build verification:"
        echo "Directory listing:"
        ls -la artifacts/arm64/
        echo ""
        echo "Looking for QuickLauncher-ARM64.app..."
        find artifacts/arm64/ -name "*.app" -type d || echo "No .app directories found"
        echo ""
        
        if [ -d "artifacts/arm64/QuickLauncher-ARM64.app" ]; then
          echo "‚úÖ ARM64 app bundle exists"
          echo "Contents directory:"
          ls -la "artifacts/arm64/QuickLauncher-ARM64.app/Contents/"
          echo ""
          echo "Binary verification:"
          file "artifacts/arm64/QuickLauncher-ARM64.app/Contents/MacOS/QuickLauncher"
          echo ""
          echo "Bundle identifier:"
          /usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "artifacts/arm64/QuickLauncher-ARM64.app/Contents/Info.plist" || echo "‚ö†Ô∏è Could not read bundle identifier"
        else
          echo "‚ùå ARM64 app bundle missing"
          echo "Available items:"
          find artifacts/arm64/ -type f -o -type d | head -10
          exit 1
        fi
        
        echo ""
        echo "üéâ Both architecture builds verified successfully!"
        echo "üìä Build summary:"
        echo "  - Intel (x86_64): ‚úÖ"
        echo "  - ARM64 (Apple Silicon): ‚úÖ"
        echo "  - Build artifacts uploaded: ‚úÖ"
        echo "  - Dependencies resolved: ‚úÖ"
        echo "  - Ready for release: ‚úÖ"
        
    - name: Test Icon Update Script
      run: |
        echo "üé® Testing icon update script..."
        if [ -f "scripts/update_app_icons.sh" ] && [ -f "Resources/app-icon.png" ]; then
          # Test script syntax
          bash -n scripts/update_app_icons.sh
          echo "‚úÖ Icon update script syntax OK"
        else
          echo "‚ö†Ô∏è Icon update script or icon file not found"
        fi
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: macos-14
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Initialize Submodules (Fallback)
      if: failure()
      run: |
        echo "ğŸ”§ Initializing submodules as fallback..."
        git submodule update --init --recursive
        
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
          LocalDependencies
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift', '*.xcodeproj/**', 'LocalDependencies/**') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build Release
      run: |
        # Set minimum macOS version for compatibility
        export MACOSX_DEPLOYMENT_TARGET=10.15
        
        # Clean previous builds
        rm -rf build
        rm -rf DerivedData*
        
        # Build Intel version for macOS 10.15 compatibility using Xcode project
        echo "ğŸ—ï¸ Building Intel (x86_64) version..."
        xcodebuild -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Release \
          -arch x86_64 \
          -derivedDataPath DerivedData-Intel \
          MACOSX_DEPLOYMENT_TARGET=10.15 \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -allowProvisioningUpdates \
          clean build
        
        # Copy Intel binary
        cp "DerivedData-Intel/Build/Products/Release/QuickLauncher.app" "QuickLauncher-Intel.app"
        
        # Build ARM64 version for macOS 11.0 compatibility
        echo "ğŸ—ï¸ Building Apple Silicon (ARM64) version..."
        xcodebuild -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Release \
          -arch arm64 \
          -derivedDataPath DerivedData-ARM64 \
          MACOSX_DEPLOYMENT_TARGET=11.0 \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -allowProvisioningUpdates \
          clean build
        
        # Copy ARM64 binary
        cp "DerivedData-ARM64/Build/Products/Release/QuickLauncher.app" "QuickLauncher-ARM64.app"
        
        # Verify binary compatibility
        echo "ğŸ” Checking Intel binary compatibility:"
        file QuickLauncher-Intel.app/Contents/MacOS/QuickLauncher
        
        echo "ğŸ” Checking ARM64 binary compatibility:"
        file QuickLauncher-ARM64.app/Contents/MacOS/QuickLauncher
        
        # List available binaries
        echo "ğŸ“‹ Available binaries:"
        ls -la QuickLauncher-*.app
      
    - name: Package Applications
      run: |
        # Create Intel version
        echo "ğŸ“¦ Packaging Intel version..."
        mkdir -p Release/Intel
        
        # Ensure the app has correct permissions and structure
        chmod -R 755 QuickLauncher-Intel.app
        mv QuickLauncher-Intel.app Release/Intel/
        
        # Update Info.plist for Intel version
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 10.15" "Release/Intel/QuickLauncher.app/Contents/Info.plist"
        
        # Create ARM64 version
        echo "ğŸ“¦ Packaging ARM64 version..."
        mkdir -p Release/ARM64
        
        # Ensure the app has correct permissions and structure
        chmod -R 755 QuickLauncher-ARM64.app
        mv QuickLauncher-ARM64.app Release/ARM64/
        
        # Update Info.plist for ARM64 version
        /usr/libexec/PlistBuddy -c "Set :LSMinimumSystemVersion 11.0" "Release/ARM64/QuickLauncher.app/Contents/Info.plist"
        
        # Copy Resources and localization files to both versions
        echo "ğŸŒ Copying resources and localization files..."
        for arch in Intel ARM64; do
          # Copy Assets if they exist
          if [ -d "QuickLauncher/Assets.xcassets" ]; then
            cp -r QuickLauncher/Assets.xcassets "Release/$arch/QuickLauncher.app/Contents/Resources/"
          fi
          
          # Copy localization files
          if [ -d "QuickLauncher/de.lproj" ]; then
            mkdir -p "Release/$arch/QuickLauncher.app/Contents/Resources/"
            cp -r QuickLauncher/*.lproj "Release/$arch/QuickLauncher.app/Contents/Resources/" 2>/dev/null || true
          fi
          
          # Copy MainMenu.xib if needed
          if [ -f "QuickLauncher/MainMenu.xib" ]; then
            mkdir -p "Release/$arch/QuickLauncher.app/Contents/Resources/"
            cp QuickLauncher/MainMenu.xib "Release/$arch/QuickLauncher.app/Contents/Resources/"
          fi
          
          echo "âœ… $arch resources copied"
        done
        
        # Verify app structure
        for arch in Intel ARM64; do
          echo "ğŸ” Verifying $arch app structure:"
          find "Release/$arch/QuickLauncher.app" -name "*.png" -o -name "*.icns" | head -5 || echo "No icon files found"
          ls -la "Release/$arch/QuickLauncher.app/Contents/Resources/" | head -10 || echo "No Resources directory found"
        done
        
    - name: Code Sign (Self-Signed)
      run: |
        # Apply ad-hoc signatures to both versions
        echo "ğŸ” Signing Intel version..."
        codesign --force --deep --sign "-" --options runtime Release/Intel/QuickLauncher.app
        codesign --verify --verbose Release/Intel/QuickLauncher.app || true
        
        echo "ğŸ” Signing ARM64 version..."
        codesign --force --deep --sign "-" --options runtime Release/ARM64/QuickLauncher.app
        codesign --verify --verbose Release/ARM64/QuickLauncher.app || true
        
    - name: Code Sign (Optional - Developer Certificate)
      if: env.APPLE_SIGNING_IDENTITY != ''
      run: |
        echo "ğŸ›ï¸ Applying developer certificate signature..."
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/Intel/QuickLauncher.app
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/ARM64/QuickLauncher.app
      env:
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        
    - name: Create DMG
      run: |
        # Create DMG installers for both architectures
        chmod +x scripts/create-simple-dmg.sh
        
        echo "ğŸ“¦ Creating Intel DMG installer..."
        ./scripts/create-simple-dmg.sh "Release/Intel/QuickLauncher.app" "QuickLauncher-Intel.dmg"
        
        echo "ğŸ“¦ Creating ARM64 DMG installer..."
        ./scripts/create-simple-dmg.sh "Release/ARM64/QuickLauncher.app" "QuickLauncher-ARM64.dmg"
        
    - name: Create ZIP
      run: |
        # Create ZIP archives for both architectures
        cd Release/Intel
        zip -r ../../QuickLauncher-Intel.zip QuickLauncher.app
        cd ../ARM64
        zip -r ../../QuickLauncher-ARM64.zip QuickLauncher.app
        cd ../..
        
    - name: Generate Checksum
      run: |
        # Generate SHA256 checksums for all release files
        shasum -a 256 QuickLauncher-Intel.dmg > QuickLauncher-Intel.dmg.sha256
        shasum -a 256 QuickLauncher-ARM64.dmg > QuickLauncher-ARM64.dmg.sha256
        shasum -a 256 QuickLauncher-Intel.zip > QuickLauncher-Intel.zip.sha256
        shasum -a 256 QuickLauncher-ARM64.zip > QuickLauncher-ARM64.zip.sha256
        
    - name: Generate Release Notes
      run: |
        cat > release_notes.md << 'EOF'
        # ğŸš€ QuickLauncher ${{ github.ref_name }}
        
        ## ğŸ—ï¸ æ¶æ„æ”¯æŒè¯´æ˜
        
        æœ¬ç‰ˆæœ¬æ”¯æŒå¤šæ¶æ„ï¼Œè¯·æ ¹æ®ä½ çš„ Mac èŠ¯ç‰‡é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ï¼š
        
        | æ¶æ„ç‰ˆæœ¬ | æ”¯æŒç³»ç»Ÿ | é€‚ç”¨è®¾å¤‡ | ä¸‹è½½æ–‡ä»¶ |
        |---------|---------|---------|---------|
        **Intel (x86_64)** | macOS 10.15+ | Intel èŠ¯ç‰‡ Mac | `QuickLauncher-Intel.dmg/zip` |
        **Apple Silicon (ARM64)** | macOS 11.0+ | M123 èŠ¯ç‰‡ Mac | `QuickLauncher-ARM64.dmg/zip` |
        
        ### ğŸ”§ å®‰è£…æ–¹æ³•
        
        1. **DMG å®‰è£…åŒ…** (æ¨è)
           - æ ¹æ®èŠ¯ç‰‡é€‰æ‹©å¯¹åº”ç‰ˆæœ¬ï¼š`QuickLauncher-Intel.dmg` æˆ– `QuickLauncher-ARM64.dmg`
           - åŒå‡»æŒ‚è½½ï¼Œæ‹–æ‹½åº”ç”¨åˆ° Applications æ–‡ä»¶å¤¹
           - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å…è®¸è¿è¡Œ
        
        2. **ZIP å‹ç¼©åŒ…**
           - æ ¹æ®èŠ¯ç‰‡é€‰æ‹©ï¼š`QuickLauncher-Intel.zip` æˆ– `QuickLauncher-ARM64.zip`
           - è§£å‹åå°† `QuickLauncher.app` å¤åˆ¶åˆ° Applications æ–‡ä»¶å¤¹
        
        ### ğŸ” æƒé™è®¾ç½®
        
        QuickLauncher éœ€è¦ä»¥ä¸‹æƒé™æ‰èƒ½æ­£å¸¸å·¥ä½œï¼š
        
        **å¿…éœ€æƒé™ï¼š**
        - **Apple Events æƒé™**ï¼šç”¨äºä¸ Finder äº¤äº’ï¼Œè·å–æ–‡ä»¶è·¯å¾„
        - **è¾…åŠ©åŠŸèƒ½æƒé™**ï¼šç”¨äºç›‘å¬å¿«æ·é”®å’Œç³»ç»Ÿäº‹ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰
        
        **è®¾ç½®æ–¹æ³•ï¼š**
        1. æ‰“å¼€ **ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§**
        2. ç‚¹å‡» **è¾…åŠ©åŠŸèƒ½** æˆ– **è‡ªåŠ¨åŒ–**
        3. æ·»åŠ  QuickLauncher å¹¶å‹¾é€‰å…è®¸
        4. é‡å¯åº”ç”¨ä½¿æƒé™ç”Ÿæ•ˆ
        
        ### âœ¨ åŠŸèƒ½ç‰¹æ€§
        
        - ğŸš€ **å¿«é€Ÿå¯åŠ¨**ï¼šä¸€é”®å¯åŠ¨å¸¸ç”¨çš„åº”ç”¨å’Œè„šæœ¬
        - ğŸ“‚ **è·¯å¾„ç®¡ç†**ï¼šå¿«é€Ÿå¤åˆ¶å’Œè®¿é—®æ–‡ä»¶è·¯å¾„
        - âŒ¨ï¸ **å¿«æ·é”®æ”¯æŒ**ï¼šè‡ªå®šä¹‰å¿«æ·é”®æé«˜æ•ˆç‡
        - ğŸ¯ **çŠ¶æ€æ é›†æˆ**ï¼šéšæ—¶éšåœ°è®¿é—®å¸¸ç”¨åŠŸèƒ½
        - ğŸ **åŸç”Ÿä½“éªŒ**ï¼šä¸“ä¸º macOS è®¾è®¡ï¼Œç•Œé¢ç®€æ´ä¼˜é›…
        - ğŸŒ **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡ç•Œé¢
        
        ### ğŸ”§ ä¸»è¦åŠŸèƒ½
        
        1. **å¿«é€Ÿå¯åŠ¨å™¨**
           - æ”¯æŒæ·»åŠ å¸¸ç”¨åº”ç”¨ã€è„šæœ¬ã€æ–‡ä»¶è·¯å¾„
           - æ™ºèƒ½æœç´¢å’Œåˆ†ç±»ç®¡ç†
           - è‡ªå®šä¹‰å¿«æ·é”®å¯åŠ¨
        
        2. **è·¯å¾„å·¥å…·**
           - ä¸€é”®å¤åˆ¶å½“å‰æ–‡ä»¶è·¯å¾„
           - æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
           - è·¯å¾„æ ¼å¼è½¬æ¢
        
        3. **è„šæœ¬æ‰§è¡Œ**
           - æ”¯æŒ Shell è„šæœ¬å¿«é€Ÿæ‰§è¡Œ
           - å¸¸ç”¨å‘½ä»¤æ”¶è—å’Œç®¡ç†
           - æ‰§è¡Œç»“æœæŸ¥çœ‹
        
        ### ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚
        
        - **Intel ç‰ˆæœ¬**: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
        - **ARM64 ç‰ˆæœ¬**: macOS 11.0 (Big Sur) æˆ–æ›´é«˜ç‰ˆæœ¬
        - éœ€è¦ Apple Events å’Œè¾…åŠ©åŠŸèƒ½æƒé™
        
        ### ğŸ“ ä½¿ç”¨æ–¹æ³•
        
        1. å¯åŠ¨åº”ç”¨åï¼ŒçŠ¶æ€æ ä¼šæ˜¾ç¤º QuickLauncher å›¾æ ‡
        2. ç‚¹å‡»çŠ¶æ€æ å›¾æ ‡æ‰“å¼€ä¸»ç•Œé¢
        3. æ·»åŠ å¸¸ç”¨çš„åº”ç”¨ã€è„šæœ¬æˆ–æ–‡ä»¶è·¯å¾„
        4. è®¾ç½®å¿«æ·é”®æˆ–ç›´æ¥ç‚¹å‡»å¯åŠ¨
        
        ### âŒ¨ï¸ é»˜è®¤å¿«æ·é”®
        
        - `âŒ˜ + â‡§ + Q`ï¼šæ‰“å¼€ QuickLauncher ä¸»ç•Œé¢
        - `âŒ˜ + â‡§ + C`ï¼šå¤åˆ¶å½“å‰æ–‡ä»¶è·¯å¾„
        - `âŒ˜ + â‡§ + R`ï¼šåˆ·æ–°åº”ç”¨åˆ—è¡¨
        
        ### ğŸ”— ç›¸å…³é“¾æ¥
        
        - [ä½¿ç”¨æ–‡æ¡£](https://github.com/tekintian/QuickLauncher/blob/main/README.md)
        - [å¿«é€Ÿå¼€å§‹](https://github.com/tekintian/QuickLauncher/blob/main/QUICK_START.md)
        - [å›¾æ ‡æ›´æ–°å·¥å…·](https://github.com/tekintian/QuickLauncher/blob/main/scripts/README_update_icons.md)
        - [é—®é¢˜åé¦ˆ](https://github.com/tekintian/QuickLauncher/issues)
        
        ---
        
        **ğŸ“Š æ–‡ä»¶æ ¡éªŒ**
        - SHA256 æ ¡éªŒå’Œæ–‡ä»¶å·²æä¾›ï¼Œè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
        - `shasum -a 256 -c QuickLauncher-Intel.dmg.sha256` (Intel ç‰ˆæœ¬)
        - `shasum -a 256 -c QuickLauncher-ARM64.dmg.sha256` (ARM64 ç‰ˆæœ¬)
        
        **âš ï¸ å…è´£å£°æ˜**
        æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ å’Œä¸ªäººä½¿ç”¨ï¼Œä½¿ç”¨é£é™©è‡ªè´Ÿã€‚
        
        **ğŸ”„ æ›´æ–°æ—¥å¿—**
        è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/tekintian/QuickLauncher/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        EOF
        
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          QuickLauncher-Intel.dmg
          QuickLauncher-Intel.dmg.sha256
          QuickLauncher-ARM64.dmg
          QuickLauncher-ARM64.dmg.sha256
          QuickLauncher-Intel.zip
          QuickLauncher-Intel.zip.sha256
          QuickLauncher-ARM64.zip
          QuickLauncher-ARM64.zip.sha256
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# Description: GitHub Actions workflow to build QuickLauncher for macOS
# Triggers on push to main, master, or develop branches, and pull requests to these branches.
# Builds Intel and ARM64 versions, with optional code signing (self-signed or developer certificate).
# Generates release notes highlighting features, improvements, and installation instructions.
# author: tekintian@gmail.com   https://dev.tekin.cn
# date: 2025-12-20
# version: 1.0.0
# license: MIT
name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: macos-latest
    
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            deployment_target: "10.15"
            config_name: "Intel"
          - arch: arm64
            deployment_target: "11.0"
            config_name: "ARM64"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Update Package Dependencies for CI
      run: |
        echo "üì¶ Updating Xcode project to use remote dependencies for CI..."
        
        # Backup original project file
        cp QuickLauncher.xcodeproj/project.pbxproj QuickLauncher.xcodeproj/project-local.pbxproj
        
        # Update Xcode project to use remote ShortcutRecorder
        sed 's|repositoryURL = "file://./LocalDependencies/ShortcutRecorder";|repositoryURL = "https://github.com/tekintian/ShortcutRecorder.git";|g' QuickLauncher.xcodeproj/project.pbxproj > temp.pbxproj && mv temp.pbxproj QuickLauncher.xcodeproj/project.pbxproj
        
        # Also update Package.swift for consistency
        cat > Package-ci.swift << 'EOF'
        // swift-tools-version:5.3
        // Package definition for QuickLauncher with remote dependencies (CI only)
        
        import PackageDescription
        
        let package = Package(
            name: "QuickLauncher",
            platforms: [
                .macOS(.v10_15)
            ],
            dependencies: [
                // Use remote ShortcutRecorder dependency for CI builds
                .package(url: "https://github.com/tekintian/ShortcutRecorder.git", from: "3.4.0")
            ],
            targets: [
                // ËøôÈáåÂÆö‰πâÈ°πÁõÆÁöÑ‰∏ªË¶ÅÁõÆÊ†á
                // Ê≥®ÊÑèÔºöËøô‰∏ªË¶ÅÊòØ‰∏∫‰∫ÜÂåÖËß£ÊûêÔºåÂÆûÈôÖÊûÑÂª∫‰ΩøÁî®XcodeÈ°πÁõÆ
            ]
        )
        EOF
        
        # Backup original Package.swift and use CI version
        cp Package.swift Package-local.swift
        cp Package-ci.swift Package.swift
        
        echo "‚úÖ Dependencies updated for CI build"
        
    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift', '*.xcodeproj/**') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Build (${{ matrix.config_name }})
      run: |
        echo "üèóÔ∏è Building ${{ matrix.config_name }} version..."
        export MACOSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }}
        
        # Build using Xcode workspace with enhanced parameters
        xcodebuild -workspace QuickLauncher.xcworkspace \
          -scheme QuickLauncher \
          -configuration Debug \
          -arch ${{ matrix.arch }} \
          -derivedDataPath "DerivedData-${{ matrix.config_name }}" \
          MACOSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }} \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_BITCODE=NO \
          PRODUCT_BUNDLE_IDENTIFIER=cn.tekin.QuickLauncher \
          MARKETING_VERSION=1.0.0 \
          CURRENT_PROJECT_VERSION=1 \
          DEVELOPMENT_LANGUAGE=en \
          -allowProvisioningUpdates \
          clean build
          
        # Verify build succeeded
        echo "üîç Checking ${{ matrix.config_name }} build results..."
        if [ ! -d "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app" ]; then
          echo "‚ùå ${{ matrix.config_name }} build failed - no app bundle found"
          find "DerivedData-${{ matrix.config_name }}" -name "*.app" -type d || echo "No app bundles found"
          exit 1
        fi
        ls -la "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app/Contents/"
        
        # Check binary
        echo "üîç Verifying ${{ matrix.config_name }} binary..."
        file "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app/Contents/MacOS/QuickLauncher"
        
        # Show app structure
        echo "üìã App structure:"
        find "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app" -name "*.plist" | head -3
        
        # Create CI build artifacts
        echo "üì¶ Creating CI artifacts for ${{ matrix.config_name }}..."
        mkdir -p CI-Artifacts
        
        # Copy the built app
        cp -R "DerivedData-${{ matrix.config_name }}/Build/Products/Debug/QuickLauncher.app" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
        
        # Ensure proper permissions
        chmod -R 755 "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app"
        
        # NOTE: Resources are already compiled and included by Xcode build
        # No need to copy source resources - they would corrupt the built app structure
        
        # Apply ad-hoc signature for macOS compatibility
        echo "üîê Applying ad-hoc signature..."
        codesign --force --deep --sign "-" --options runtime "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" || echo "‚ö†Ô∏è Ad-hoc signing failed (may be expected on CI)"
        
        # Verify app structure in artifact
        echo "üîç Verifying CI artifact structure..."
        ls -la "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/"
        
        # Test basic app functionality (comprehensive validation)
        echo "üß™ Running comprehensive app validation..."
        
        # Check Info.plist
        if [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Info.plist" ]; then
          echo "‚úÖ Info.plist exists"
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Info.plist" 2>/dev/null || echo "cn.tekin.QuickLauncher")
          echo "üìã Bundle ID: $BUNDLE_ID"
        else
          echo "‚ùå Info.plist missing"
          exit 1
        fi
        
        # Check executable
        if [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ]; then
          echo "‚úÖ Executable exists"
          BINARY_INFO=$(file "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher")
          echo "üìã Binary: $BINARY_INFO"
        else
          echo "‚ùå Executable missing"
          exit 1
        fi
        
        # Check Resources
        if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources" ]; then
          echo "‚úÖ Resources directory exists"
          ASSETS_COUNT=$(find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources" -name "*.xcassets" | wc -l)
          LOCALIZATION_COUNT=$(find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/Resources" -name "*.lproj" | wc -l)
          echo "üìã Assets: $ASSETS_COUNT, Localization: $LOCALIZATION_COUNT"
        else
          echo "‚ö†Ô∏è Resources directory missing (may be optional)"
        fi
        
        # Check code signature
        echo "üîç Checking code signature..."
        if codesign --verify --verbose "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" 2>/dev/null; then
          echo "‚úÖ Code signature valid"
        else
          echo "‚ö†Ô∏è Code signature verification failed (may be expected for ad-hoc signing)"
        fi
        
        # Test basic macOS compatibility
        echo "üß™ Testing macOS compatibility..."
        if [ -x "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" ]; then
          echo "‚úÖ Executable has proper permissions"
          # Quick architecture check
          ARCH_CHECK=$(lipo -info "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/Contents/MacOS/QuickLauncher" 2>/dev/null || echo "Single arch")
          echo "üìã Architecture: $ARCH_CHECK"
        else
          echo "‚ùå Executable not executable"
          exit 1
        fi
        
        echo "‚úÖ ${{ matrix.config_name }} build and artifact creation completed"
        
        # Show final artifact structure
        echo "üì¶ Final CI artifact structure:"
        ls -la CI-Artifacts/
        if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" ]; then
          echo "App bundle structure:"
          find "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" -name "Contents" -type d | while read contents_dir; do
            echo "üìÅ $contents_dir"
            ls -la "$contents_dir/"
          done
        fi
        
        # Final integrity test
        echo "üîç Running final integrity test..."
        APP_SIZE=$(du -sh "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app" | cut -f1)
        echo "üìä App bundle size: $APP_SIZE"
        
        # Verify required directory structure
        REQUIRED_DIRS=("Contents/MacOS" "Contents/Resources" "Contents")
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [ -d "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/$dir" ]; then
            echo "‚úÖ Directory $dir exists"
          else
            echo "‚ö†Ô∏è Directory $dir missing"
          fi
        done
        
        # Verify required files
        REQUIRED_FILES=("Contents/Info.plist" "Contents/MacOS/QuickLauncher")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "CI-Artifacts/QuickLauncher-${{ matrix.config_name }}.app/$file" ]; then
            echo "‚úÖ File $file exists"
          else
            echo "‚ùå Required file $file missing"
            exit 1
          fi
        done
        
        # Restore original files
        if [ -f "Package-local.swift" ]; then
          echo "üîÑ Restoring original Package.swift..."
          cp Package-local.swift Package.swift
        fi
        
        if [ -f "QuickLauncher.xcodeproj/project-local.pbxproj" ]; then
          echo "üîÑ Restoring original Xcode project..."
          cp QuickLauncher.xcodeproj/project-local.pbxproj QuickLauncher.xcodeproj/project.pbxproj
        fi
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickLauncher-${{ matrix.config_name }}-CI-${{ github.run_number }}
        path: CI-Artifacts/
        retention-days: 7
        if-no-files-found: error
        
    - name: Lint
      run: |
        echo "üîç Running basic checks..."
        
        # Check for common Swift linting issues
        if command -v swiftlint &> /dev/null; then
          swiftlint --strict
        else
          echo "‚ö†Ô∏è SwiftLint not available, skipping linting"
        fi
        
        # Check file structure
        echo "üìÅ Checking project structure..."
        if [ ! -f "QuickLauncher/Info.plist" ]; then
          echo "‚ùå Missing QuickLauncher/Info.plist"
          exit 1
        fi
        
        if [ ! -d "QuickLauncher/Assets.xcassets" ]; then
          echo "‚ö†Ô∏è Missing assets directory"
        fi
        
        # Check script permissions
        echo "üîß Checking script permissions..."
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            if [ ! -x "$script" ]; then
              echo "‚ö†Ô∏è Script $script is not executable"
              chmod +x "$script"
            fi
          fi
        done
        
        echo "‚úÖ Basic checks completed"
        
  verify-builds:
    needs: build
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download Intel Build
      uses: actions/download-artifact@v4
      with:
        name: QuickLauncher-Intel-CI-${{ github.run_number }}
        path: artifacts/intel/
        
    - name: Download ARM64 Build
      uses: actions/download-artifact@v4
      with:
        name: QuickLauncher-ARM64-CI-${{ github.run_number }}
        path: artifacts/arm64/
        
    - name: Verify Both Builds
      run: |
        echo "üîç Verifying downloaded CI builds..."
        
        # Check Intel build
        echo "üìã Intel build verification:"
        echo "Directory listing:"
        ls -la artifacts/intel/
        echo ""
        echo "Looking for QuickLauncher-Intel.app..."
        find artifacts/intel/ -name "*.app" -type d || echo "No .app directories found"
        echo ""
        
        if [ -d "artifacts/intel/QuickLauncher-Intel.app" ]; then
          echo "‚úÖ Intel app bundle exists"
          echo "Contents directory:"
          ls -la "artifacts/intel/QuickLauncher-Intel.app/Contents/"
          echo ""
          echo "Binary verification:"
          file "artifacts/intel/QuickLauncher-Intel.app/Contents/MacOS/QuickLauncher"
          echo ""
          echo "Bundle identifier:"
          /usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "artifacts/intel/QuickLauncher-Intel.app/Contents/Info.plist" || echo "‚ö†Ô∏è Could not read bundle identifier"
        else
          echo "‚ùå Intel app bundle missing"
          echo "Available items:"
          find artifacts/intel/ -type f -o -type d | head -10
          exit 1
        fi
        
        echo ""
        echo "=========================================="
        echo ""
        
        # Check ARM64 build
        echo "üìã ARM64 build verification:"
        echo "Directory listing:"
        ls -la artifacts/arm64/
        echo ""
        echo "Looking for QuickLauncher-ARM64.app..."
        find artifacts/arm64/ -name "*.app" -type d || echo "No .app directories found"
        echo ""
        
        if [ -d "artifacts/arm64/QuickLauncher-ARM64.app" ]; then
          echo "‚úÖ ARM64 app bundle exists"
          echo "Contents directory:"
          ls -la "artifacts/arm64/QuickLauncher-ARM64.app/Contents/"
          echo ""
          echo "Binary verification:"
          file "artifacts/arm64/QuickLauncher-ARM64.app/Contents/MacOS/QuickLauncher"
          echo ""
          echo "Bundle identifier:"
          /usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "artifacts/arm64/QuickLauncher-ARM64.app/Contents/Info.plist" || echo "‚ö†Ô∏è Could not read bundle identifier"
        else
          echo "‚ùå ARM64 app bundle missing"
          echo "Available items:"
          find artifacts/arm64/ -type f -o -type d | head -10
          exit 1
        fi
        
        echo ""
        echo "üéâ Both architecture builds verified successfully!"
        echo "üìä Build summary:"
        echo "  - Intel (x86_64): ‚úÖ"
        echo "  - ARM64 (Apple Silicon): ‚úÖ"
        echo "  - Build artifacts uploaded: ‚úÖ"
        echo "  - Dependencies resolved: ‚úÖ"
        echo "  - Ready for release: ‚úÖ"
        
    - name: Test Icon Update Script
      run: |
        echo "üé® Testing icon update script..."
        if [ -f "scripts/update_app_icons.sh" ] && [ -f "Resources/app-icon.png" ]; then
          # Test script syntax
          bash -n scripts/update_app_icons.sh
          echo "‚úÖ Icon update script syntax OK"
        else
          echo "‚ö†Ô∏è Icon update script or icon file not found"
        fi
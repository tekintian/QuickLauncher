# Description: GitHub Actions workflow to build and release QuickLauncher for macOS
# Triggers on new version tags (v*), builds Intel and ARM64 versions,
# creates release assets (DMG, ZIP, SHA256), and publishes to GitHub Releases.
# Uses self-signed code signing, with optional developer certificate signing.
# Generates detailed release notes highlighting features, improvements, and installation instructions.
# author: tekintian@gmail.com   https://dev.tekin.cn
# date: 2025-12-20
# version: 2.0.0
# license: MIT
name: Release

on:
  push:
    branches: [ main, master, dev ]
    # Trigger release workflow on new version tags
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - config_name: Intel
            architecture: x86_64
            deployment_target: "10.13"
          - config_name: ARM64
            architecture: arm64
            deployment_target: "11.0"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CI Environment
      run: |
        chmod +x scripts/ci-setup.sh
        ./scripts/ci-setup.sh

    - name: Install Dependencies
      run: |
        set -euo pipefail
        echo "ğŸ“¦ Installing dependencies..."
        # Install tools needed for release packaging
        if ! command -v xz &> /dev/null; then
          echo "ğŸº Installing xz..."
          brew install xz
        else
          echo "âœ… xz is already installed"
        fi

    - name: Build App
      run: |
        # Use proper destination that includes architecture
        if [[ "${{ matrix.architecture }}" == "x86_64" ]]; then
          DESTINATION="platform=macOS,arch=x86_64"
        else
          DESTINATION="platform=macOS,arch=arm64"
        fi
        
        xcodebuild clean build \
          -project QuickLauncher.xcodeproj \
          -scheme QuickLauncher \
          -configuration Release \
          -derivedDataPath DerivedData-${{ matrix.config_name }} \
          -destination "$DESTINATION" \
          MACOSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
        # tar the build output for reference (same as CI workflow)
        echo "ğŸ“¦ Saving build output..."
        tar -cJf build-output-${{ matrix.config_name }}.tar.xz DerivedData-${{ matrix.config_name }}/Build/Products/
        echo "ğŸ“¦ Build output saved to build-output-${{ matrix.config_name }}.tar.xz"

    - name: Create Artifacts
      run: |
        # Find and work directly with the built app (no copy to avoid du calculation issues)
        APP_PATH=$(find DerivedData-${{ matrix.config_name }} -name "QuickLauncher.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
          echo "âŒ No app bundle found"
          exit 1
        fi
        
        echo "find app bundle at: $APP_PATH"

        # Step 3: Prepare CI-Artifacts directory (exactly like CI workflow)
        rm -rf CI-Artifacts
        mkdir -p CI-Artifacts
        # Save build output tar for reference
        mv build-output-${{ matrix.config_name }}.tar.xz CI-Artifacts/build-output-${{ matrix.config_name }}.tar.xz

        echo "ğŸ§¹ Running library cleanup script..."
   
        if [ -f "./scripts/clean-libs.sh" ]; then
          chmod +x ./scripts/clean-libs.sh
          ./scripts/clean-libs.sh "$APP_PATH"
          echo "âœ… Library cleanup completed"
        else
          echo "âš ï¸ clean-libs.sh script not found"
        fi
        
        # Basic verification
        [ -f "$APP_PATH/Contents/MacOS/QuickLauncher" ] || exit 1
        [ -x "$APP_PATH/Contents/MacOS/QuickLauncher" ] || exit 1
        
        # Step 4: Package the final app bundle (exactly like CI workflow)
        echo " moving $APP_PATH to CI-Artifacts/QuickLauncher.app "
        mv $APP_PATH CI-Artifacts/QuickLauncher.app
        cd CI-Artifacts
        echo "  ğŸ“‹ Packaging final app bundle: CI-Artifacts/QuickLauncher.app "
        tar -cJf "QuickLauncher-${{ matrix.config_name }}-Final.tar.xz" QuickLauncher.app
       
        echo "  ğŸ“Š Final package size: $(du -sh QuickLauncher-${{ matrix.config_name }}-Final.tar.xz | cut -f1)" 
        # Show all packages
        echo "ğŸ“‹ All generated packages:"
        ls -lh *.tar.xz
        cd ..
        echo "âœ… ${{ matrix.config_name }} build completed"
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QuickLauncher-${{ matrix.config_name }}-${{ github.run_number }}
        path: CI-Artifacts/*.tar.xz
        retention-days: 1
        compression-level: 0
        if-no-files-found: error

  package-release:
    # Package Release Job 
    # This job packages the release artifacts into a tarball for distribution.
    needs: build # Depends on the build job
    runs-on: macos-14
    
    steps:
      # Step 1: Checkout the repository to access scripts and files
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Extract Build Artifacts
      run: |
        # Create Release directories
        rm -rf Release
        mkdir -p Release/Intel Release/ARM64
        
        # Check what artifacts were downloaded
        echo "ğŸ“‹ Downloaded artifacts structure:"
        find artifacts -type d
        ls -la artifacts/ || echo "Empty artifacts directory"

        # Find Intel and ARM64 artifacts (following ci.yml pattern)
        INTEL_ARTIFACT=$(find artifacts -name "*Intel*" -type d | head -1)
        ARM64_ARTIFACT=$(find artifacts -name "*ARM64*" -type d | head -1)
        
        echo "ğŸ“‹ Found Intel artifact: $INTEL_ARTIFACT"
        echo "ğŸ“‹ Found ARM64 artifact: $ARM64_ARTIFACT"
        
        # Process Intel artifact
        if [ -d "$INTEL_ARTIFACT" ]; then
          echo "ğŸ“‹ Processing Intel artifact..."
          cd "$INTEL_ARTIFACT"
          
          # Extract the final app package (following ci.yml naming pattern)
          if [ -f "QuickLauncher-Intel-Final.tar.xz" ]; then
            echo "ğŸ“‹ Extracting Intel final package..."
            tar -xJf QuickLauncher-Intel-Final.tar.xz
            if [ -d "QuickLauncher.app" ]; then
              echo "ğŸ“‹ Moving Intel app to Release/Intel/"
              mv QuickLauncher.app ../../Release/Intel/
            else
              echo "âŒ No QuickLauncher.app found in Intel final package"
              exit 1
            fi
          else
            echo "âŒ Intel final package not found"
            ls -la
            exit 1
          fi
          
          # Copy build output files
          cp build-output-*.tar.xz ../../ 2>/dev/null || echo "âš ï¸ Intel build output not found"
          cd ../..
        else
          echo "âŒ Intel artifact not found"
          exit 1
        fi
        
        # Process ARM64 artifact
        if [ -d "$ARM64_ARTIFACT" ]; then
          echo "ğŸ“‹ Processing ARM64 artifact..."
          cd "$ARM64_ARTIFACT"
          
          # Extract the final app package (following ci.yml naming pattern)
          if [ -f "QuickLauncher-ARM64-Final.tar.xz" ]; then
            echo "ğŸ“‹ Extracting ARM64 final package..."
            tar -xJf QuickLauncher-ARM64-Final.tar.xz
            if [ -d "QuickLauncher.app" ]; then
              echo "ğŸ“‹ Moving ARM64 app to Release/ARM64/"
              mv QuickLauncher.app ../../Release/ARM64/
            else
              echo "âŒ No QuickLauncher.app found in ARM64 final package"
              exit 1
            fi
          else
            echo "âŒ ARM64 final package not found"
            ls -la
            exit 1
          fi
          
          # Copy build output files
          cp build-output-*.tar.xz ../../ 2>/dev/null || echo "âš ï¸ ARM64 build output not found"
          cd ../..
        else
          echo "âŒ ARM64 artifact not found"
          exit 1
        fi
        
        echo "âœ… Artifacts extracted to current working directory"
        
        # Verify both architectures were built and fix permissions if needed
        echo "ğŸ“‹ Verifying build artifacts:"
        for arch in Intel ARM64; do
          if [ -d "Release/$arch/QuickLauncher.app" ]; then
            echo "âœ… $arch app: $(du -sh Release/$arch/QuickLauncher.app | cut -f1)"
            
            # Check and fix executable permissions
            EXECUTABLE="Release/$arch/QuickLauncher.app/Contents/MacOS/QuickLauncher"
            if [ -f "$EXECUTABLE" ]; then
              echo "  âœ… Executable exists: $EXECUTABLE"
              # Ensure executable has proper permissions
              chmod +x "$EXECUTABLE"
              ls -la "$EXECUTABLE"
            else
              echo "  âŒ Executable missing"
              exit 1
            fi
            
            # Verify app bundle structure
            [ -d "Release/$arch/QuickLauncher.app/Contents/Frameworks" ] && echo "  âœ… Frameworks exists" || echo "  âŒ Frameworks missing"
            [ -d "Release/$arch/QuickLauncher.app/Contents/Resources" ] && echo "  âœ… Resources exists" || echo "  âŒ Resources missing"
            
            # Fix ownership and permissions for the entire app bundle
            chown -R runner:staff "Release/$arch/QuickLauncher.app" 2>/dev/null || true
            chmod -R u+rw,go+r-w "Release/$arch/QuickLauncher.app" 2>/dev/null || true
            
          else
            echo "âŒ $arch app not found"
            exit 1
          fi
        done
        
    - name: Code Sign (Self-Signed)
      run: |
        # Apply ad-hoc signatures with proper sandbox support for both versions
        for arch in Intel ARM64; do
          echo "ğŸ” Signing $arch version..."
          
          # Ensure plugins have proper sandbox entitlements
          find "Release/$arch/QuickLauncher.app/Contents/PlugIns" -name "*.appex" -type d | while read plugin; do
            echo "  Configuring sandbox for plugin: $(basename "$plugin")"
            
            # Add required sandbox entitlements for Finder extension
            PLIST_PATH="$plugin/Contents/Info.plist"
            if [ -f "$PLIST_PATH" ]; then
              # Add sandbox entitlements for Finder sync extension
              /usr/libexec/PlistBuddy -c "Add :com.apple.security.app-sandbox bool true" "$PLIST_PATH" 2>/dev/null || echo "    Sandbox key already exists"
              /usr/libexec/PlistBuddy -c "Add :com.apple.security.files.user-selected.read-write bool true" "$PLIST_PATH" 2>/dev/null || echo "    File access key already exists"
              /usr/libexec/PlistBuddy -c "Add :com.apple.security.temporary-exception.mach-lookup.global-name array" "$PLIST_PATH" 2>/dev/null || echo "    Mach lookup array already exists"
              /usr/libexec/PlistBuddy -c "Add :com.apple.security.temporary-exception.mach-lookup.global-name:0 string com.apple.FinderSync" "$PLIST_PATH" 2>/dev/null || echo "    Finder sync entry already exists"
            fi
            
            echo "  Signing plugin: $(basename "$plugin")"
            codesign --force --sign "-" --options runtime --entitlements <(echo '<?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>com.apple.security.app-sandbox</key>
                <true/>
                <key>com.apple.security.files.user-selected.read-write</key>
                <true/>
                <key>com.apple.security.temporary-exception.mach-lookup.global-name</key>
                <array>
                    <string>com.apple.FinderSync</string>
                </array>
            </dict>
            </plist>') "$plugin" || echo "  âš ï¸ Plugin signing failed"
          done
          
          # Sign frameworks
          find "Release/$arch/QuickLauncher.app/Contents/Frameworks" -name "*.framework" -type d | while read framework; do
            echo "  Signing framework: $(basename "$framework")"
            
            # Fix framework library ID for proper dylib loading
            FRAMEWORK_NAME=$(basename "$framework" .framework)
            FRAMEWORK_BINARY="$framework/$FRAMEWORK_NAME"
            if [ -f "$FRAMEWORK_BINARY" ]; then
              echo "    Fixing framework library ID for $FRAMEWORK_NAME"
              install_name_tool -id "@rpath/$FRAMEWORK_NAME.framework/Versions/A/$FRAMEWORK_NAME" "$FRAMEWORK_BINARY" 2>/dev/null || echo "    Library ID already correct"
            fi
            
            codesign --force --sign "-" --options runtime "$framework" || echo "  âš ï¸ Framework signing failed"
          done
          
          # Fix main app dependency paths
          echo "  Fixing main app dependency paths..."
          MAIN_BINARY="Release/$arch/QuickLauncher.app/Contents/MacOS/QuickLauncher"
          if [ -f "$MAIN_BINARY" ]; then
            # Fix dylib references to use proper framework paths
            install_name_tool -change "@rpath/QuickLauncher.debug.dylib" "@rpath/QuickLauncherCore.framework/Versions/A/QuickLauncherCore" "$MAIN_BINARY" 2>/dev/null || echo "    Dependencies already correct"
          fi
          
          # Sign main app
          echo "  Signing main app bundle..."
          codesign --force --deep --sign "-" --options runtime "Release/$arch/QuickLauncher.app" || echo "âš ï¸ Main app signing failed"
          codesign --verify --verbose "Release/$arch/QuickLauncher.app" || echo "âš ï¸ Signature verification failed (may be expected for ad-hoc)"
        done
        
    - name: Code Sign (Optional - Developer Certificate)
      if: env.APPLE_SIGNING_IDENTITY != ''
      run: |
        echo "ğŸ›ï¸ Applying developer certificate signature..."
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/Intel/QuickLauncher.app
        codesign --force --verify --verbose --sign "${{ secrets.APPLE_SIGNING_IDENTITY }}" Release/ARM64/QuickLauncher.app
      env:
        APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        
    - name: Create DMG
      run: |
        # Create DMG installers for both architectures
        chmod +x scripts/create-simple-dmg.sh
        
        echo "ğŸ“¦ Creating Intel DMG installer..."
        ./scripts/create-simple-dmg.sh "Release/Intel/QuickLauncher.app" "QuickLauncher-Intel.dmg"
        
        echo "ğŸ“¦ Creating ARM64 DMG installer..."
        ./scripts/create-simple-dmg.sh "Release/ARM64/QuickLauncher.app" "QuickLauncher-ARM64.dmg"
        
    - name: Create ZIP
      run: |
        # Create ZIP archives for both architectures
        cd Release/Intel
        zip -r ../../QuickLauncher-Intel.zip QuickLauncher.app
        cd ../ARM64
        zip -r ../../QuickLauncher-ARM64.zip QuickLauncher.app
        cd ../..
        
    - name: Generate Checksum
      run: |
        # Generate SHA256 checksums for all release files
        shasum -a 256 QuickLauncher-Intel.dmg > QuickLauncher-Intel.dmg.sha256
        shasum -a 256 QuickLauncher-ARM64.dmg > QuickLauncher-ARM64.dmg.sha256
        shasum -a 256 QuickLauncher-Intel.zip > QuickLauncher-Intel.zip.sha256
        shasum -a 256 QuickLauncher-ARM64.zip > QuickLauncher-ARM64.zip.sha256
        
    - name: Generate Release Notes
      run: |
        # Get version from tag or commit hash
        if [[ "$GITHUB_REF" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="build-$(git rev-parse --short HEAD)"
        fi
        
        # Generate release notes in both Chinese and English
        cat > release_notes.md << EOF
        # ğŸš€ QuickLauncher $VERSION
        
        ## ç®€ä½“ä¸­æ–‡ | Chinese
        
        QuickLauncher æ˜¯ä¸€æ¬¾å¼ºå¤§çš„ macOS ç”Ÿäº§åŠ›å·¥å…·ï¼Œè®©æ‚¨å¯ä»¥ä» Finder å³é”®èœå•ç›´æ¥å¯åŠ¨ç»ˆç«¯å’Œä»£ç ç¼–è¾‘å™¨ã€‚
        
        ### âœ¨ æ ¸å¿ƒç‰¹æ€§
        - ğŸ–±ï¸ æ— ç¼ Finder é›†æˆï¼Œå³é”®èœå•å¿«é€Ÿè®¿é—®
        - ğŸ“± æ”¯æŒ 35+ åº”ç”¨ç¨‹åºï¼ˆç»ˆç«¯ã€ç¼–è¾‘å™¨ã€IDEï¼‰
        - ğŸŒ å¤šè¯­è¨€æ”¯æŒï¼ˆç®€ä½“ä¸­æ–‡ã€Englishç­‰9ç§è¯­è¨€ï¼‰
        - âš¡ å…¨å±€å¿«æ·é”®å’ŒçŠ¶æ€æ é›†æˆ
        - ğŸ”§ è‡ªå®šä¹‰åº”ç”¨é…ç½®
        
        ### ğŸ—ï¸ æ¶æ„æ”¯æŒ
        - **Intel (x86_64)**: é€‚ç”¨äº Intel èŠ¯ç‰‡ Mac (macOS 10.13+)
        - **Apple Silicon (ARM64)**: é€‚ç”¨äº M123 èŠ¯ç‰‡ Mac (macOS 11.0+)
        
        ### ğŸ“¦ å®‰è£…æ–¹æ³•
        1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æˆ– ZIP æ–‡ä»¶
        2. å°† QuickLauncher.app æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
        3. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå¦‚é‡åˆ°å®‰å…¨æç¤ºï¼Œè¯·é€‰æ‹©"ä»è¦æ‰“å¼€"
        4. åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æˆäºˆå¿…è¦çš„æƒé™ï¼ˆè¾…åŠ©åŠŸèƒ½ã€Apple Eventsï¼‰
        
        ### ğŸ” æƒé™è®¾ç½®
        - ç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > è¾…åŠ©åŠŸèƒ½
        - æ·»åŠ  QuickLauncher å¹¶å‹¾é€‰å…è®¸
        
        ### âš ï¸ è‡ªç­¾ååº”ç”¨è¯´æ˜
        - **é¦–æ¬¡å¯åŠ¨**: macOS å¯èƒ½æç¤º"æ— æ³•æ‰“å¼€'QuickLauncher.app'ï¼Œå› ä¸ºå®ƒæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…"
          - è§£å†³æ–¹æ¡ˆï¼šåœ¨ Finder ä¸­å³é”®ç‚¹å‡» QuickLauncher.app â†’ é€‰æ‹©"æ‰“å¼€" â†’ ç‚¹å‡»"æ‰“å¼€"ç¡®è®¤
          - æˆ–å‰å¾€ï¼šç³»ç»Ÿè®¾ç½® > éšç§ä¸å®‰å…¨æ€§ > å®‰å…¨æ€§ â†’ ç‚¹å‡»"ä»è¦æ‰“å¼€"
        - **æƒé™æˆäºˆ**: é¦–æ¬¡ä½¿ç”¨å³é”®åŠŸèƒ½æ—¶ï¼Œéœ€è¦åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ‰‹åŠ¨æˆäºˆç›¸å…³æƒé™
        - **ç½‘ç»œè®¿é—®**: æœ¬åº”ç”¨ä¸ºè‡ªç­¾åï¼Œå¯èƒ½éœ€è¦ç³»ç»Ÿå…è®¸è¿è¡ŒæœªéªŒè¯çš„åº”ç”¨
        
        ---
        
        ## English
        
        QuickLauncher is a powerful macOS productivity tool that allows you to launch terminals and code editors directly from Finder's context menu.
        
        ### âœ¨ Key Features
        - ğŸ–±ï¸ Seamless Finder integration with right-click menu access
        - ğŸ“± Support for 35+ applications (terminals, editors, IDEs)
        - ğŸŒ Multi-language support (9 languages including Chinese and English)
        - âš¡ Global shortcuts and menu bar integration
        - ğŸ”§ Custom application configuration
        
        ### ğŸ—ï¸ Architecture Support
        - **Intel (x86_64)**: For Intel-based Mac (macOS 10.13+)
        - **Apple Silicon (ARM64)**: For M123-based Mac (macOS 11.0+)
        
        ### ğŸ“¦ Installation
        1. Download the appropriate DMG or ZIP file for your architecture
        2. Drag QuickLauncher.app to Applications folder
        3. On first launch, if security prompt appears, choose "Open Anyway"
        4. Grant necessary permissions in System Settings (Accessibility, Apple Events)
        
        ### ğŸ” Permissions
        - System Settings > Privacy & Security > Accessibility
        - Add QuickLauncher and check allow
        
        ### âš ï¸ Self-Signed Application Notice
        - **First Launch**: macOS may show "QuickLauncher.app" can't be opened because it is from an unidentified developer"
          - Solution: Right-click QuickLauncher.app in Finder â†’ Select "Open" â†’ Click "Open" to confirm
          - Alternatively: System Settings > Privacy & Security > Security â†’ Click "Open Anyway"
        - **Permission Grant**: When first using right-click features, manually grant required permissions in System Settings
        - **Network Access**: As a self-signed app, macOS may require allowing unverified applications to run
        
        ### ğŸ”— Links
        - ğŸ“– [Documentation](https://github.com/tekintian/QuickLauncher/blob/main/README.md)
        - ğŸš€ [Quick Start](https://github.com/tekintian/QuickLauncher/blob/main/QUICK_START.md)
        - ğŸ› [Issues](https://github.com/tekintian/QuickLauncher/issues)
        
        ### ğŸ“ˆ File Verification
        \`\`\`bash
        # Verify file integrity
        shasum -a 256 -c QuickLauncher-*.dmg.sha256
        \`\`\`
        
        ---
        
        ğŸŒŸ If QuickLauncher helps you, please consider giving this project a Star!
        EOF
        
    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          QuickLauncher-Intel.dmg
          QuickLauncher-Intel.dmg.sha256
          QuickLauncher-ARM64.dmg
          QuickLauncher-ARM64.dmg.sha256
          QuickLauncher-Intel.zip
          QuickLauncher-Intel.zip.sha256
          QuickLauncher-ARM64.zip
          QuickLauncher-ARM64.zip.sha256
          build-output-Intel.tar.xz
          build-output-ARM64.tar.xz
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}